#include <STC8G.h>
#include <intrins.h>
//å¦ä¸€ç§é£æ ¼ï¼Œå¾…æµ‹ğŸ›
// å®å®šä¹‰
#define P54_MASK 0x10  // P5.4 çš„æ©ç 
#define P55_MASK 0x20  // P5.5 çš„æ©ç 

// å®šä¹‰ IO å£æ¨¡å¼
#define IO_MODE_INPUT      0x00  // è¾“å…¥æ¨¡å¼
#define IO_MODE_OUTPUT     0x01  // è¾“å‡ºæ¨¡å¼
#define IO_MODE_BIDIRECTIONAL 0x02  // æ ‡å‡†åŒå‘å£æ¨¡å¼
#define IO_MODE_OPENDRAIN  0x03  // å¼€æ¼æ¨¡å¼

// å®šä¹‰ IO å£é…ç½®å‡½æ•°
#define SET_PIN_MODE(port, pin, mode) \
    do { \
        port##M1 &= ~(1 << pin); \
        port##M0 &= ~(1 << pin); \
        port##M0 |= ((mode) << pin); \
    } while (0)

// å»¶æ—¶å‡½æ•°ï¼ˆ1msï¼‰
void delay_1ms() {
    unsigned char i, j;
    _nop_();
    i = 12;
    j = 169;
    do {
        while (--j);
    } while (--i);
}

// åˆå§‹åŒ–GPIO
void GPIO_Init(void) {
    // è®¾ç½®P5.4ä¸ºæ ‡å‡†åŒå‘å£
    SET_PIN_MODE(P5, 4, IO_MODE_BIDIRECTIONAL);

    // è®¾ç½®P5.5ä¸ºæ ‡å‡†åŒå‘å£
    SET_PIN_MODE(P5, 5, IO_MODE_BIDIRECTIONAL);

    // è®¾ç½®P3.3ä¸ºæ¨æŒ½è¾“å‡ºæ¨¡å¼
    SET_PIN_MODE(P3, 3, IO_MODE_OUTPUT);

    // é»˜è®¤è®¾ç½®P3.3ä¸ºä½ç”µå¹³ï¼Œç»§ç”µå™¨å…³é—­
    P33 = 0;
}

// æ§åˆ¶ç»§ç”µå™¨å¼€
void Relay_On(void) {
    P33 = 1;
}

// æ§åˆ¶ç»§ç”µå™¨å…³
void Relay_Off(void) {
    P33 = 0;
}

// æ¶ˆæŠ–å¤„ç†å‡½æ•°
unsigned char Debounce_Read(unsigned char pin_mask) {
    unsigned char stable_count = 0;
    while (stable_count < 5) {  // è¿ç»­5æ¬¡è¯»å–ä¸€è‡´æ‰ç®—ç¨³å®š
        if ((P5 & pin_mask) == 0) {
            stable_count++;
        } else {
            stable_count = 0;
        }
        delay_1ms();  // å»¶æ—¶1ms
    }
    return (P5 & pin_mask) ? 1 : 0;
}

// å…¨å±€å˜é‡
unsigned char relay_state = 0;       // ç»§ç”µå™¨çŠ¶æ€æ ‡å¿—
unsigned int p55_timer = 0;          // P5.5 è®¡æ—¶ï¼ˆå•ä½ï¼šmsï¼‰
unsigned char p54_control_valid = 0; // P5.4 æ§åˆ¶æ˜¯å¦æœ‰æ•ˆæ ‡å¿—

// æ£€æŸ¥å…‰ç”µå¼€å…³çŠ¶æ€å¹¶æ§åˆ¶ç»§ç”µå™¨
void Check_Sensor(void) {
    static unsigned char last_p54_state = 0;
    unsigned char current_p54_state;
    unsigned char current_p55_state;

    // è·å–å½“å‰P5.5çŠ¶æ€
    current_p55_state = (P5 & P55_MASK) ? 1 : 0;

    // å¦‚æœP5.5ä¸ºä½ç”µå¹³ï¼Œç«‹å³ç¦æ­¢P5.4æ§åˆ¶å¹¶å…³é—­ç»§ç”µå™¨
    if (current_p55_state == 0) {
        p54_control_valid = 0;
        Relay_Off();
        relay_state = 0;
        last_p54_state = 0;
        p55_timer = 0;  // åœæ­¢è®¡æ—¶
    } else {
        // å¦‚æœP5.5ä¸ºé«˜ç”µå¹³ï¼Œå¼€å§‹è®¡æ—¶
        p55_timer++;
        delay_1ms();  // æ¯è°ƒç”¨ä¸€æ¬¡è¯¥å‡½æ•°ï¼Œå»¶æ—¶1ms

        // å¦‚æœè®¡æ—¶è¾¾åˆ°10ç§’ï¼Œå…è®¸P5.4æ§åˆ¶ç»§ç”µå™¨
        if (p55_timer >= 10000) {  // 10ç§’
            p54_control_valid = 1;  // å…è®¸P5.4æ§åˆ¶ç»§ç”µå™¨
        }
    }

    // æ ¹æ®P5.4çŠ¶æ€æ§åˆ¶ç»§ç”µå™¨
    if (p54_control_valid) {
        current_p54_state = Debounce_Read(P54_MASK);

        // æ£€æµ‹çŠ¶æ€å˜åŒ–
        if (current_p54_state != last_p54_state) {
            delay_1ms();
            delay_1ms();  // æ¶ˆæŠ–å»¶æ—¶2ms
            current_p54_state = Debounce_Read(P54_MASK);

            if (current_p54_state != last_p54_state) {
                // å®ç°é«˜ç”µå¹³æ§åˆ¶
                if (current_p54_state == 1 && !relay_state) {
                    Relay_On();  // æ‰“å¼€ç»§ç”µå™¨
                    relay_state = 1;
                } else if (current_p54_state == 1 && relay_state) {
                    Relay_Off();  // å…³é—­ç»§ç”µå™¨
                    relay_state = 0;
                }

                // æ›´æ–°P5.4çš„ä¸Šä¸€ä¸ªçŠ¶æ€
                last_p54_state = current_p54_state;
            }
        }
    }
}

// ä¸»å‡½æ•°
void main(void) {
    GPIO_Init();  // åˆå§‹åŒ–GPIO

    while (1) {
        Check_Sensor();  // ä¸æ–­æ£€æµ‹å…‰ç”µå¼€å…³çŠ¶æ€å¹¶æ§åˆ¶ç»§ç”µå™¨
    }
}